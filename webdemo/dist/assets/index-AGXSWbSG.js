(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();class _{x;y;constructor(t=0,e=0){this.x=t,this.y=e}add(t){this.x+=t.x,this.y+=t.y}sub(t){this.x-=t.x,this.y-=t.y}scale(t){this.x*=t,this.y*=t}addmult(t,e){this.x+=e.x*t,this.y+=e.x*t}submult(t,e){this.x-=e.x*t,this.y-=e.x*t}negate(){this.x*=-1,this.y*=-1}}function T(l,t){return new _(l.x+t.x,l.y+t.y)}function Z(l,t){return new _(l.x-t.x,l.y-t.y)}function O(l,t){return new _(l.x*t,l.y*t)}function W(l,t){const e=Math.cos(t),i=Math.sin(t);return new _(l.x*e-l.y*i,l.x*i+l.y*e)}class at{camera;mult;start_world_size;desired_aspect;screen_size;constructor(t,e,i){const s={width:t.canvas.width,height:t.canvas.height},o={w2s:t.canvas.width/i,s2w:i/t.canvas.width},n={pos:new _,zoom:1,viewport:{width:i,height:i/e}};this.camera=n,this.mult=o,this.start_world_size={width:i,height:i/e},this.desired_aspect=e,this.screen_size=s}update(t){window.innerWidth/window.innerHeight>this.desired_aspect?(t.canvas.height=window.innerHeight,t.canvas.width=t.canvas.height*this.desired_aspect):(t.canvas.width=window.innerWidth,t.canvas.height=t.canvas.width/this.desired_aspect),this.screen_size.width=t.canvas.width,this.screen_size.height=t.canvas.height,this.mult.s2w=this.start_world_size.width/this.screen_size.width*this.camera.zoom,this.mult.w2s=this.screen_size.width/this.start_world_size.width/this.camera.zoom}updateViewPort(){const t=new _(this.screen_size.width,this.screen_size.height),e=O(t,this.mult.s2w);this.camera.viewport={width:e.x,height:e.y}}adjustCameraZoom(t,e){const i=this.s2w(e);this.camera.zoom/=t,this.mult.w2s=this.screen_size.width/this.start_world_size.width/this.camera.zoom,this.mult.s2w=this.start_world_size.width/this.screen_size.width*this.camera.zoom;const s=this.s2w(e),o=Z(s,i);this.camera.pos.sub(o),this.updateViewPort()}adjustCameraPos(t){this.camera.pos.sub(t)}w2s(t){const e=this.mult.w2s*(t.x-this.camera.pos.x),i=this.screen_size.height-this.mult.w2s*(t.y-this.camera.pos.y);return new _(e,i)}s2w(t){const e=t.x*this.mult.s2w+this.camera.pos.x,i=(this.screen_size.height-t.y)*this.mult.s2w+this.camera.pos.y;return new _(e,i)}map(t,e,i,s,o){return s+(t-e)*(s-o)/(e-i)}}var C=(l=>(l[l.disc=0]="disc",l[l.rectangle=1]="rectangle",l))(C||{});class N{static ZigTranslation;ptr;zig;constructor(t,e){const i=t.getRigidBodyPtrFromId(e);this.ptr=i,this.zig={id:e,aabb:{pos:new _(t.getRigidBodyAABBPosX(i),t.getRigidBodyAABBPosY(i)),half_width:t.getRigidBodyAABBHalfWidth(i),half_height:t.getRigidBodyAABBHalfHeight(i)},static:t.isRigidBodyStatic(i),num_normals:t.getRigidBodyNumNormals(i),type:t.getRigidBodyType(i),props:{pos:new _(t.getRigidBodyPosX(i),t.getRigidBodyPosY(i)),momentum:new _(t.getRigidBodyMomentumX(i),t.getRigidBodyMomentumY(i)),force:new _(t.getRigidBodyForceX(i),t.getRigidBodyForceY(i)),mass:t.getRigidBodyMass(i),angle:t.getRigidBodyAngle(i),ang_momentum:t.getRigidBodyAngularMomentum(i),torque:t.getRigidBodyTorque(i),inertia:t.getRigidBodyInertia(i),mu:t.getRigidBodyFrictionCoeff(i)},implementation_ptr:t.getRigidBodyImplementation(i)}}getImplementationDiscBody(t){return{radius:t.getDiscBodyRadiusAssumeType(this.zig?.implementation_ptr)}}getImplementationRectangleBody(t){return{width:t.getRectangleBodyWidthAssumeType(this.zig?.implementation_ptr),height:t.getRectangleBodyHeightAssumeType(this.zig?.implementation_ptr)}}getImplementation(t){switch(this.zig?.type){case 0:return this.getImplementationDiscBody(t);case 1:return this.getImplementationRectangleBody(t);default:throw new Error("Undefined type. Could not return implementation")}}}class ct{bbox;action_type;loc;text;text_size;state;constructor(t,e,i,s,o){t.font=r.label.font_size+"px "+r.font,t.textBaseline="middle";const n=t.measureText(o),a=n.width,c=n.fontBoundingBoxAscent+n.fontBoundingBoxDescent;this.bbox={left:s.x,top:s.y,right:s.x+a,bottom:s.y+c},this.text=o,this.action_type=e,this.text_size=r.label.font_size,this.state=0,this.loc=i}render(t){let e=g.string(g.white);this.state==1&&(e=r.widget.hover_bg_color),t.font=this.text_size+"px "+r.font,t.fillStyle=e,t.textBaseline="middle",t.textAlign="center";const i=(this.bbox.left+this.bbox.right)/2,s=(this.bbox.top+this.bbox.bottom)/2;t.fillText(this.text,i,s)}requestAction(t){if(this.action_type==null)return{wants_focus:!1,action:null};const[e,i]=[t.mouse_position.x,t.mouse_position.y];return h.isInside(this.bbox,e,i)&&this.action_type!=null&&(this.state=1),this.state==1?{wants_focus:t.mouse_frame.clicked,action:this.action_type}:{wants_focus:!1,action:null}}}var I=(l=>(l[l.default=0]="default",l[l.hovered=1]="hovered",l[l.clicked=2]="clicked",l[l.down=3]="down",l[l.released=4]="released",l))(I||{});class K{bbox;action_type;loc;text;state;constructor(t,e,i,s,o,n,a){t.font=r.button.font_size+"px "+r.font,t.textBaseline="middle";const c=t.measureText(o),m=c.width+2*r.button.padding,u=n!=null&&n>m?n:m,f=c.fontBoundingBoxAscent+c.fontBoundingBoxDescent+2*r.button.padding,b=a!=null&&a>f?a:f;this.bbox={left:s.x,top:s.y,right:s.x+u,bottom:s.y+b},this.text=o,this.action_type=e,this.state=0,this.loc=i}render(t){let e=r.widget.default_bg_color;this.state==1&&(e=r.widget.hover_bg_color),this.state==2&&(e=r.widget.down_bg_color),this.state==3&&(e=r.widget.down_bg_color),this.state==4&&(e=r.widget.down_bg_color),t.fillStyle=e,t.fillRect(this.bbox.left,this.bbox.top,h.calcWidth(this.bbox),h.calcHeight(this.bbox)),t.font=`normal ${r.button.font_size}px ${r.font}`,t.fillStyle=g.string(g.white),t.textBaseline="middle",t.textAlign="center";const i=(this.bbox.left+this.bbox.right)/2,s=(this.bbox.top+this.bbox.bottom)/2;t.fillText(this.text,i,s)}requestAction(t){if(this.action_type==null)return{wants_focus:!1,action:null};const[e,i]=[t.mouse_position.x,t.mouse_position.y];if(h.isInside(this.bbox,e,i)){const s=JSON.stringify(t.active_widget_loc)==JSON.stringify(this.loc);t.mouse_frame.clicked?(this.state=2,t.active_widget_loc=JSON.parse(JSON.stringify(this.loc))):s&&t.mouse_frame.released?this.state=4:s&&t.mouse_down?this.state=3:this.state=1}return this.state==2||this.state==3?{wants_focus:!0,action:null}:this.state==4?{wants_focus:!1,action:this.action_type}:{wants_focus:!1,action:null}}}class Q{bbox;action_type;loc;text;state;constructor(t,e,i,s,o,n){t.font=r.button.font_size+"px "+r.font,t.textBaseline="middle";const a=t.measureText(o),c=a.width,m=a.fontBoundingBoxAscent+a.fontBoundingBoxDescent;this.bbox={left:s.x,top:s.y,right:s.x+(n||c+2*r.button.padding),bottom:s.y+m+2*r.button.padding},this.text=o,this.action_type=e,this.state=0,this.loc=i}render(t){let e=r.widget.default_bg_color;this.state==1&&(e=r.widget.hover_bg_color),this.state==2&&(e=r.widget.down_bg_color),this.state==3&&(e=r.widget.down_bg_color),this.state==4&&(e=r.widget.down_bg_color),t.fillStyle=e,t.fillRect(this.bbox.left,this.bbox.top,h.calcWidth(this.bbox),h.calcHeight(this.bbox)),t.font="lighter "+r.button.font_size+"px "+r.font,t.fillStyle=g.string(g.white),t.textBaseline="middle",t.textAlign="center";const i=Math.round((this.bbox.left+this.bbox.right)/2)+.5,s=Math.round((this.bbox.top+this.bbox.bottom)/2)+1;t.fillText(this.text,i,s)}requestAction(t){if(this.action_type==null)return{wants_focus:!1,action:null};const[e,i]=[t.mouse_position.x,t.mouse_position.y],s=h.isInside(this.bbox,e,i);return s&&t.mouse_frame.clicked?(this.state=2,t.active_widget_loc=JSON.parse(JSON.stringify(this.loc))):JSON.stringify(t.active_widget_loc)==JSON.stringify(this.loc)&&t.mouse_frame.released?this.state=4:JSON.stringify(t.active_widget_loc)==JSON.stringify(this.loc)&&t.mouse_down?this.state=3:s&&(this.state=1),this.state==2||this.state==3?{wants_focus:!0,action:this.action_type}:this.state==4?{wants_focus:!1,action:null}:{wants_focus:!1,action:null}}}class dt{bbox;action_type;loc;text;text_size;max_width;state;wrapped_lines;constructor(t,e,i,s,o,n){t.font=r.text.font_size+"px "+r.font,t.textBaseline="middle",this.max_width=n,this.text=o,this.action_type=e,this.text_size=r.text.font_size,this.state=0,this.loc=i,this.wrapped_lines=this.wrapText(t,o,n);let a=0;for(let u=0;u<this.wrapped_lines.length;u++){const f=t.measureText(this.wrapped_lines[u]).width;a<f&&(a=f)}const c=this.text_size*r.text.text_height_mult,m=this.wrapped_lines.length*c;this.bbox={left:s.x,top:s.y,right:s.x+a,bottom:s.y+m}}wrapText(t,e,i){const s=e.split(" "),o=[];let n="";for(let a of s){const c=n+(n?" ":"")+a;t.measureText(c).width>i?(n&&o.push(n),n=a):n=c}return n&&o.push(n),o}render(t){let e=g.string(g.white);this.state==1&&(e=r.widget.hover_bg_color),t.font=this.text_size+"px "+r.font,t.fillStyle=e,t.textBaseline="middle",t.textAlign="left";const i=this.text_size*1.2;let s=this.bbox.top+i/2;for(let o of this.wrapped_lines){const n=this.bbox.left;t.fillText(o,n,s),s+=i}}requestAction(t){if(this.action_type==null)return{wants_focus:!1,action:null};const[e,i]=[t.mouse_position.x,t.mouse_position.y];return h.isInside(this.bbox,e,i)&&this.action_type!=null&&(this.state=1),this.state==1?{wants_focus:t.mouse_frame.clicked,action:this.action_type}:{wants_focus:!1,action:null}}}class ht{bbox;action_type;loc;color;constructor(t,e,i,s,o,n){this.color=s,this.bbox={left:i.x,top:i.y,right:i.x+o,bottom:i.y+n},this.action_type=t,this.loc=e}render(t){const e=h.calcWidth(this.bbox),i=h.calcHeight(this.bbox),s=g.toHSVA(this.color),o={h:s.h,s:s.s,v:s.v,a:s.a};o.s=1,o.v=1;const n=g.string(g.fromHSVA(o.h,o.s,o.v,o.a)),a=t.createLinearGradient(this.bbox.left,this.bbox.top,this.bbox.right,this.bbox.top);a.addColorStop(0,"white"),a.addColorStop(1,n),t.fillStyle=a,t.fillRect(this.bbox.left,this.bbox.top,e,i);const c=t.createLinearGradient(this.bbox.left,this.bbox.top,this.bbox.left,this.bbox.bottom);c.addColorStop(0,"rgba(0, 0, 0, 0)"),c.addColorStop(1,"rgba(0, 0, 0, 1)"),t.fillStyle=c,t.fillRect(this.bbox.left,this.bbox.top,e,i);const m=s.s*e+this.bbox.left,u=(1-s.v)*i+this.bbox.top;t.beginPath(),t.arc(m,u,5,0,2*Math.PI),t.fillStyle=g.string(this.color),t.fill(),t.lineWidth=3,t.strokeStyle="black",t.stroke(),t.lineWidth=2,t.strokeStyle="white",t.stroke(),t.closePath()}requestAction(t){if(this.action_type==null)return{wants_focus:!1,action:null};const[e,i]=[t.mouse_position.x,t.mouse_position.y];if(h.isInside(this.bbox,e,i)&&t.mouse_frame.clicked&&(t.active_widget_loc=this.loc),JSON.stringify(t.active_widget_loc)==JSON.stringify(this.loc)&&t.mouse_down){const n=h.calcWidth(this.bbox),a=h.calcHeight(this.bbox),c=p=>Math.min(Math.max(p,.0015),.999),m=c((e-this.bbox.left)/n),u=c(1-(i-this.bbox.top)/a),f=g.toHSVA(this.color);let b;if(u===0)b=g.fromHSVA(f.h,m,0,this.color.a);else if(m===0)b=g.fromHSVA(f.h,0,u,this.color.a);else{const p=g.toHSVA(this.color);b=g.fromHSVA(p.h,m,u,this.color.a)}return this.color=b,t.action_ret_var=this.color,{wants_focus:!0,action:this.action_type}}return{wants_focus:!1,action:null}}}class L{bbox;action_type;loc;widgets;cursor;constructor(t,e,i,s,o,n){this.cursor={x:i+r.layout_commons.padding,y:s},this.bbox={left:i,top:s,right:i+o,bottom:s+n},this.action_type=t,this.loc=e,this.widgets=[]}getInnerWidth(){return h.calcWidth(this.bbox)-2*r.layout_commons.padding}pushWidget(t){this.widgets.push(t)}render(t){for(let e=this.widgets.length-1;e>=0;e--)this.widgets[e].render(t)}requestAction(t){const e=n=>{if(t.active_widget_loc.length===0)return!0;const a=t.active_widget_loc.slice(0,n.loc.length);return a.length===n.loc.length&&a.every((c,m)=>c===n.loc[m])},[i,s]=[t.mouse_position.x,t.mouse_position.y],o=h.isInside(this.bbox,i,s);if(!o&&t.active_widget_loc.length==0)return{iters:null,wants_focus:!1,action:null};if(!t.moving_window)for(let n=0;n<this.widgets.length;n++){const a=this.widgets[n];if(!e(a))continue;const c=a.requestAction(t);if(c.wants_focus||c.action!=null||!(a instanceof L)&&h.isInside(a.bbox,i,s)&&a.action_type!=null&&!(a instanceof E))return{iters:n,wants_focus:c.wants_focus,action:c.action}}return t.active_widget_loc.length>1&&JSON.stringify(t.active_widget_loc)!=JSON.stringify(this.loc)?(t.active_widget_loc=[],{iters:null,wants_focus:!1,action:null}):this.action_type==null?{iters:null,wants_focus:!1,action:null}:(o&&t.mouse_frame.clicked&&(t.moving_window=!0,t.active_widget_loc=this.loc),t.moving_window&&t.mouse_frame.released&&(t.moving_window=!1,t.active_widget_loc=[]),{iters:null,wants_focus:!1,action:null})}makeLabel(t,e,i){const s=new ct(t,e,this.loc.concat([this.widgets.length]),this.cursor,i);return this.pushWidget(s),s}makeButton(t,e,i,s){const o=new K(t,e,this.loc.concat([this.widgets.length]),this.cursor,i,s?.width,s?.height);return this.pushWidget(o),o}makeDraggable(t,e,i,s){const o=new Q(t,e,this.loc.concat([this.widgets.length]),this.cursor,i,s?.width);return this.pushWidget(o),o}makeText(t,e,i,s){const o=new dt(t,e,this.loc.concat([this.widgets.length]),this.cursor,i,s??h.calcWidth(this.bbox)-2*r.layout_commons.padding);return this.pushWidget(o),o}makeColorPickerRect(t,e,i,s){const o=new ht(t,this.loc.concat([this.widgets.length]),this.cursor,e,i,s);return this.pushWidget(o),o}resetCursor(){this.cursor.x=this.bbox.left+2*r.layout_commons.widget_gap,this.cursor.y=this.widgets[this.widgets.length-1].bbox.bottom+r.layout_commons.widget_gap}}class E{bbox;action_type;loc;widgets;title;title_font_size;window_state;constructor(t,e,i,s,o,n){this.action_type=e,this.title=i,this.title_font_size=r.header_commons.font_size,this.bbox={left:s,top:o,right:s+n,bottom:o+1.4*r.header_commons.font_size},this.loc=t,this.widgets=[],this.window_state="open"}render(t){t.fillStyle=this.window_state=="open"?r.header_commons.bg_color:r.window.minimized_header_bg,t.fillRect(this.bbox.left,this.bbox.top,h.calcWidth(this.bbox),h.calcHeight(this.bbox)),t.font=this.title_font_size+"px "+r.font,t.fillStyle=r.header_commons.color,t.textBaseline="middle",t.textAlign="left";const e=this.bbox.left+r.layout_commons.widget_gap,i=(this.bbox.top+this.bbox.bottom)/2;t.fillText(this.title,e,i)}requestAction(t){if(this.action_type==null)return{wants_focus:!1,action:null};const[e,i]=[t.mouse_position.x,t.mouse_position.y];return h.isInside(this.bbox,e,i)&&t.mouse_frame.double_clicked?{wants_focus:!1,action:this.action_type}:{wants_focus:!1,action:null}}}class U extends Q{constructor(t,e,i,s,o){super(t,e,i,s,o)}}class j extends K{constructor(t,e,i,s){super(t,e,i,s,"x")}render(t){let e=r.widget.default_bg_color;this.state==I.hovered&&(e=r.widget.hover_bg_color),this.state==I.clicked&&(e=r.widget.down_bg_color),this.state==I.down&&(e=r.widget.down_bg_color),this.state==I.released&&(e=r.widget.down_bg_color);const i=(this.bbox.left+this.bbox.right)/2;let s=(this.bbox.top+this.bbox.bottom)/2;s+=r.button.font_size*.1,t.fillStyle=e,t.beginPath(),t.arc(i,s,.5*r.button.font_size,0,2*Math.PI),t.fill(),t.closePath(),t.font=`normal ${1.25*r.button.font_size}px ${r.font}`,t.fillStyle=g.string(g.white),t.textBaseline="middle",t.textAlign="center",t.fillText(this.text,i,s)}}class P extends L{min_size;header_height;offset;mode;tools;constructor(t,e,i,s,o,n,a,c,m,u,f,b){super(e,n,a,c,m,u),this.offset=0,this.mode="normal",this.tools={min_width:0,max_width:h.calcWidth(this.bbox)};const p=this.loc.concat([]);p.push(this.widgets.length),s!=null&&this.widgets.push(new U(t,s,p,{x:this.bbox.right-27,y:this.bbox.bottom-20},"res"));const x=this.loc.concat([]);x.push(this.widgets.length),o!=null&&this.widgets.push(new j(t,o,x,{x:this.bbox.right-15,y:this.bbox.top-2.5}));const z=n.concat([]);z.push(this.widgets.length);const k=new E(z,i,f,this.cursor.x,this.cursor.y,10);this.widgets.push(k),this.cursor.y+=h.calcHeight(k.bbox)+r.layout_commons.widget_gap,this.header_height=h.calcHeight(k.bbox),this.min_size=b,k.bbox.left=this.bbox.left,k.bbox.right=this.bbox.right}updateBBox(){}setMode(t,e){switch(this.mode=t,this.mode){case"normal":break;case"two columns":this.offset=this.widgets.length,e!=null&&(this.tools.min_width=e.min_width!=null?e.min_width:this.tools.min_width,this.tools.max_width=e.max_width!=null?e.max_width:this.tools.max_width);break}}pushWidget(t){switch(super.pushWidget(t),this.mode){case"normal":this.cursor.y+=h.calcHeight(t.bbox)+r.layout_commons.widget_gap;break;case"two columns":if((this.widgets.length-this.offset)%2==0){this.cursor.x=this.bbox.left+r.layout_commons.padding;const e=this.widgets.length-1,i=Math.max(h.calcHeight(this.widgets[e].bbox),h.calcHeight(this.widgets[e-1].bbox));this.cursor.y+=i+r.layout_commons.widget_gap}else this.cursor.x+=Math.min(this.tools.max_width,Math.max(this.tools.min_width,h.calcWidth(this.bbox)))/2;break}}render(t){t.save();const e=r.layout_commons.border_width;t.beginPath(),t.rect(this.bbox.left,this.bbox.top,h.calcWidth(this.bbox),h.calcHeight(this.bbox)),t.closePath(),t.fillStyle=g.string(r.layout_commons.bg_color),t.fillRect(this.bbox.left,this.bbox.top,h.calcWidth(this.bbox),h.calcHeight(this.bbox)),t.strokeStyle=r.layout_commons.border,t.lineWidth=e,t.strokeRect(this.bbox.left-.5*e,this.bbox.top-.5*e,h.calcWidth(this.bbox)+e,h.calcHeight(this.bbox)+e),t.clip(),super.render(t),t.restore()}requestAction(t){return t.mouse_position.x,{minimise:!1,close:!1,resize:!1,iters:null,wants_focus:!1,action:null}}requestWindowAction(t,e){const i=super.requestAction(e);return i.iters==null?{minimise:!1,close:!1,resize:!1,...i}:this.widgets[i.iters]instanceof E?{minimise:i.action!=null,close:!1,resize:!1,...i}:this.widgets[i.iters]instanceof U&&!t?{minimise:!1,close:!1,resize:i.action!=null,...i}:this.widgets[i.iters]instanceof j?{minimise:!1,close:i.action!=null,resize:!1,...i}:t?{minimise:!1,close:!1,resize:!1,iters:null,wants_focus:!1,action:null}:{minimise:!1,close:!1,resize:!1,...i}}}class mt extends L{columns;constructor(t,e,i,s,o,n){super(t,e,i,s,o,0),this.columns=n}updateBBox(t){const e=r.layout_commons.padding;t.bbox.top<this.bbox.top+e&&(this.bbox.top=t.bbox.top-e),t.bbox.bottom>this.bbox.bottom-e&&(this.bbox.bottom=t.bbox.bottom+e)}pushWidget(t){if(super.pushWidget(t),this.updateBBox(t),this.widgets.length%this.columns==0){let i=Number.NEGATIVE_INFINITY;for(let s=this.widgets.length-this.columns;s<this.widgets.length;s++)this.widgets[s].bbox.bottom>i&&(i=this.widgets[s].bbox.bottom);this.cursor.x=this.bbox.left+r.layout_commons.padding,this.cursor.y=i+r.layout_commons.widget_gap;return}this.cursor.x+=h.calcWidth(this.bbox)/this.columns}render(t){t.fillStyle=g.string(r.layout_commons.bg_color),t.fillRect(this.bbox.left,this.bbox.top,h.calcWidth(this.bbox),h.calcHeight(this.bbox)),t.strokeStyle=r.layout_commons.border,t.lineWidth=1,t.strokeRect(this.bbox.left,this.bbox.top,h.calcWidth(this.bbox),h.calcHeight(this.bbox)),super.render(t)}requestAction(t){const e=i=>{if(t.active_widget_loc.length===0)return!0;const s=t.active_widget_loc.slice(0,i.loc.length);return s.length===i.loc.length&&s.every((o,n)=>o===i.loc[n])};if(!t.moving_window)for(let i=0;i<this.widgets.length;i++){const s=this.widgets[i];if(!e(s))continue;const o=s.requestAction(t);if(o.wants_focus||o.action!=null)return{iters:i,...o}}return{iters:null,wants_focus:!1,action:null}}}class ut{bbox;widgets;constructor(){this.bbox={left:0,right:0,top:0,bottom:0},this.widgets=[]}render(t){t.lineWidth=1}stack_render(t,e){for(let i=e.window_order.length-1;i>=0;i--){const s=e.window_order[i];e.window_active[s]&&this.widgets[s].render(t)}}makeWindow(t,e,i,s){const o=this.widgets.length;e.window_offsets.length<=this.widgets.length&&(e.window_offsets.push({x:0,y:0}),e.window_positions.push({x:s.x??0,y:s.y??0}),e.window_sizes.push({width:s.width??200,height:s.height??200}),e.window_active.push(!0),e.window_minimised.push(!1),e.window_order.unshift(o));const n=new P(t,i.window,i.header,i.resizeable,i.close_btn,[o],e.window_positions[o].x,e.window_positions[o].y,e.window_sizes[o].width,e.window_sizes[o].height,s.title??"Hello, World!",{width:s.min_width??50,height:s.min_height??20});return this.widgets.push(n),n}static makeGrid(t,e,i,s){const o=new mt(e,t.loc.concat([t.widgets.length]),t.cursor.x,t.cursor.y+r.layout_commons.padding,s*(t.bbox.right-t.bbox.left-2*r.layout_commons.padding),i);return t.pushWidget(o),o}endEditing(t){for(let e=0;e<this.widgets.length;e++){const i=this.widgets[e];if(t.window_active[e]&&t.window_minimised[e]&&i instanceof P){i.bbox.bottom=i.bbox.top+i.header_height;for(let s=0;s<=2;s++)if(i.widgets[s]instanceof E){i.widgets[s].window_state="minimised";break}}}}requestAction(t){this.endEditing(t);for(let e=0;e<t.window_order.length;e++){const i=t.window_order[e],s=this.widgets[i];if(t.mouse_frame.released&&(t.resizing_window=!1,document.body.style.cursor="default"),!t.window_active[i])continue;const o=s instanceof P?s.requestWindowAction(t.window_minimised[i],t):s.requestAction(t);o.wants_focus&&(t.window_order.splice(e,1),t.window_order.unshift(i));const n=o;if(s instanceof P&&n.iters!=null){if(n.resize&&(t.resizing_window=!0,document.body.style.cursor="nwse-resize"),t.resizing_window&&JSON.stringify(t.active_widget_loc)==JSON.stringify(s.widgets[n.iters].loc)){t.window_sizes[i].width+=t.window_sizes[i].width<s.min_size.width&&t.mouse_delta_pos.x<0?0:t.mouse_delta_pos.x,t.window_sizes[i].height+=t.window_sizes[i].height<s.min_size.height&&t.mouse_delta_pos.y<0?0:t.mouse_delta_pos.y;break}n.close&&(t.window_active[i]=!1),n.minimise&&(t.window_minimised[i]=!t.window_minimised[i]),t.window_minimised[i]&&(s.bbox.bottom=s.bbox.top+h.calcHeight(s.widgets[n.iters].bbox))}if(document.body.style.cursor="default",t.moving_window&&JSON.stringify(t.active_widget_loc)===JSON.stringify(s.loc)){t.mouse_frame.clicked?(t.window_order.splice(e,1),t.window_order.unshift(i),t.window_offsets[i].x=s.bbox.left-t.mouse_position.x,t.window_offsets[i].y=s.bbox.top-t.mouse_position.y):t.mouse_down&&(t.window_positions[i].x=t.window_offsets[i].x+t.mouse_position.x,t.window_positions[i].y=t.window_offsets[i].y+t.mouse_position.y);break}if(!(o.action==null&&(!h.isInside(s.bbox,t.mouse_position.x,t.mouse_position.y)||t.moving_window)))return t.mouse_frame.released&&(t.active_widget_loc=[]),o}return{wants_focus:!1,action:null}}}const q=document.createElement("style");q.type="text/css";q.appendChild(document.createTextNode(`
    @font-face {
    font-family: "Hack Regular";
    font-style: normal;
    font-weight: normal;
    src: local("Hack Regular"), url("/hack-webfont/Hack-Regular.woff") format("woff");
    }
    

    @font-face {
    font-family: "Hack Italic";
    font-style: normal;
    font-weight: normal;
    src: local("Hack Italic"), url("/hack-webfont/Hack-Italic.woff") format("woff");
    }
    

    @font-face {
    font-family: "Hack Bold";
    font-style: normal;
    font-weight: normal;
    src: local("Hack Bold"), url("/hack-webfont/Hack-Bold.woff") format("woff");
    }
    

    @font-face {
    font-family: "Hack Bold Italic";
    font-style: normal;
    font-weight: normal;
    src: local("Hack Bold Italic"), url("/hack-webfont/Hack-BoldItalic.woff") format("woff");
    }`));document.head.appendChild(q);const v=document.createElement("canvas");v.id="nvb-imgui-canvas";document.body.appendChild(v);v.style.position="absolute";v.style.top="0px";v.style.left="0px";function wt(){v.width=window.innerWidth,v.height=window.innerHeight,v.style.width=window.innerWidth+"px",v.style.height=window.innerHeight+"px"}function S(l,t){return Math.floor(l*10**t)/10**t}function ft(l,t){let e=l%t;return e<0&&(e+=t),e}function gt(l,t,e,i){i?.min!=null&&i?.max!=null&&console.assert(i.min<i.max);let s=l+e*t.mouse_delta_pos.x;return i?.min!=null&&s<i?.min&&(s=i.min),i?.max!=null&&s>i?.max&&(s=i?.max),s}class g{static white={r:255,g:255,b:255,a:1};static black={r:0,g:0,b:0,a:1};static g_18={r:18,g:19,b:18,a:1};static red={r:255,g:0,b:0,a:1};static default_bg;static EPS_DECIMALS=6;static isColor(t){return typeof t==typeof g.white}static string(t){return`rgba(${t.r}, ${t.g}, ${t.b}, ${t.a})`}static fromString(t){const e=t.match(/rgba?\((\d+),\s*(\d+),\s*(\d+),?\s*(\d*\.?\d+)?\)/);if(!e)throw new Error("Invalid color string format");const[,i,s,o,n]=e;return{r:parseInt(i,10),g:parseInt(s,10),b:parseInt(o,10),a:n!==void 0?parseFloat(n):1}}static fromHex(t){const e=t.replace("#","");if(e.length===6){const i=parseInt(e.slice(0,2),16),s=parseInt(e.slice(2,4),16),o=parseInt(e.slice(4,6),16);return{r:i,g:s,b:o,a:1}}else if(e.length===8){const i=parseInt(e.slice(0,2),16),s=parseInt(e.slice(2,4),16),o=parseInt(e.slice(4,6),16),n=parseInt(e.slice(6,8),16)/255;return{r:i,g:s,b:o,a:n}}else throw new Error("Invalid hex color format")}static toHex(t){const e=Math.round(t.r).toString(16).padStart(2,"0"),i=Math.round(t.g).toString(16).padStart(2,"0"),s=Math.round(t.b).toString(16).padStart(2,"0"),o=Math.round(t.a*255).toString(16).padStart(2,"0");return t.a===1?`#${e}${i}${s}`:`#${e}${i}${s}${o}`}static fromRGB(t){return{...t,a:1}}static fromHSVA(t,e,i,s){const o=ft(t,360),n=i*e,a=n*(1-Math.abs(o/60%2-1)),c=i-n;let[m,u,f]=[0,0,0];return 0<=o&&o<60?[m,u,f]=[n,a,0]:60<=o&&o<120?[m,u,f]=[a,n,0]:120<=o&&o<180?[m,u,f]=[0,n,a]:180<=o&&o<240?[m,u,f]=[0,a,n]:240<=o&&o<300?[m,u,f]=[a,0,n]:300<=o&&o<360&&([m,u,f]=[n,0,a]),[m,u,f]=[255*(m+c),255*(u+c),255*(f+c)],{r:S(m,this.EPS_DECIMALS),g:S(u,this.EPS_DECIMALS),b:S(f,this.EPS_DECIMALS),a:s}}static toHSVA(t){const e=t.r/255,i=t.g/255,s=t.b/255,o=Math.max(e,i,s),n=Math.min(e,i,s),a=o-n;let c=0;a==0?c=0:o===e?c=(60*((i-s)/a)+360)%360:o===i?c=(60*((s-e)/a)+120)%360:o===s&&(c=(60*((e-i)/a)+240)%360);const m=o===0?0:a/o,u=o;return{h:S(c,this.EPS_DECIMALS),s:S(m,this.EPS_DECIMALS),v:S(u,this.EPS_DECIMALS),a:t.a}}}class h{static isInside(t,e,i){return e>t.left&&e<t.right&&i>t.top&&i<t.bottom}static calcWidth(t){return t.right-t.left}static calcHeight(t){return t.bottom-t.top}static set(t,e){t.left=e.left,t.right=e.right,t.top=e.top,t.bottom=e.bottom}}class r{static font="Hack Regular";static widget={default_bg_color:"#666170FF",hover_bg_color:"#9992A8FF",down_bg_color:"#CCC2E0FF"};static label={font_size:12,default_font_color:g.white,inactive_font_color:g.fromHex("#808080FF")};static text={font_size:12,text_height_mult:1.5};static button={padding:3,font_size:12};static layout_commons={padding:10,widget_gap:5,bg_color:g.fromHex("#0F0F0FF0"),border:"#6E6E8080",border_width:1};static header_commons={color:"#ffffff",bg_color:"#4b4654",font_size:12};static window={minimized_header_bg:"#9F9F9F09"};static grid={};static popup={}}class _t{mouse_position;mouse_prev_position;mouse_delta_pos;mouse_down_position;mouse_down;mouse_frame;delta_mouse_scroll={x:0,y:0};moving_window;resizing_window;window_offsets;window_positions;window_sizes;window_active;window_minimised;window_order;active_widget_loc;action_ret_var;last_click_time;double_click_threshold;constructor(t,e,i){this.mouse_position={x:e,y:i},this.mouse_prev_position={x:e,y:i},this.mouse_down_position={x:e,y:i},this.mouse_delta_pos={x:e,y:i},this.mouse_down=!1,this.mouse_frame={clicked:!1,time_at_click:-1,time_since_click:0,double_clicked:!1,released:!1},this.delta_mouse_scroll={x:0,y:0},this.moving_window=!1,this.resizing_window=!1,this.window_offsets=[],this.window_positions=[],this.window_sizes=[],this.window_active=[],this.window_minimised=[],this.window_order=[],this.active_widget_loc=[],this.last_click_time=-1,this.double_click_threshold=300,this.action_ret_var=void 0,t.addEventListener("mousemove",s=>{const o=t.getBoundingClientRect(),n=s.clientX-o.x,a=s.clientY-o.y;this.mouse_position.x=n,this.mouse_position.y=a}),t.addEventListener("mousedown",s=>{const o=t.getBoundingClientRect(),n=s.clientX-o.x,a=s.clientY-o.y;this.mouse_down_position.x=n,this.mouse_down_position.y=a;const c=performance.now();this.mouse_frame.clicked=!0,this.last_click_time!==-1&&c-this.last_click_time<this.double_click_threshold?this.mouse_frame.double_clicked=!0:(this.mouse_frame.double_clicked=!1,c-this.last_click_time>=this.double_click_threshold&&(this.last_click_time=-1)),this.last_click_time=c,this.mouse_down=!0}),t.addEventListener("mouseup",()=>{this.mouse_frame.released=!0,this.mouse_down=!1}),t.addEventListener("wheel",s=>{this.delta_mouse_scroll.x=s.deltaX,this.delta_mouse_scroll.y=s.deltaY})}end(){this.mouse_delta_pos.x=this.mouse_position.x-this.mouse_prev_position.x,this.mouse_delta_pos.y=this.mouse_position.y-this.mouse_prev_position.y,this.mouse_prev_position.x=this.mouse_position.x,this.mouse_prev_position.y=this.mouse_position.y;const t=performance.now();this.mouse_frame.time_at_click!==-1&&(this.mouse_frame.time_since_click=t-this.mouse_frame.time_at_click),this.mouse_frame.clicked&&(this.mouse_frame.time_at_click=t),t-this.last_click_time>=this.double_click_threshold&&(this.mouse_frame.time_at_click=-1,this.mouse_frame.time_since_click=0,this.last_click_time=-1),this.mouse_frame.clicked=!1,this.mouse_frame.released=!1,this.mouse_frame.double_clicked=!1,this.delta_mouse_scroll.x=0,this.delta_mouse_scroll.y=0}}const w=v.getContext("2d"),y=new _t(v,0,0),A={wheel:"/wheel.png",red_truck:"../red_truck.png"};class bt{units;textures;constructor(t,e,i){this.units=new at(t,e,i),this.textures=new Map}render(t,e){e.clearRect(0,0,e.canvas.width,e.canvas.height),this.units.update(e);var i=new _(y.mouse_position.x,y.mouse_position.y);const s=e.canvas.getBoundingClientRect();i.sub(new _(s.left,s.top));const o=this.units.s2w(i),n=this.units.w2s(o);if(e.beginPath(),e.fillStyle="#1481FF",e.arc(n.x,n.y,5,0,2*Math.PI),e.fill(),e.closePath(),y.delta_mouse_scroll.y!=0&&this.units.adjustCameraZoom(Math.exp(-y.delta_mouse_scroll.y/500),i),y.mouse_down&&!y.moving_window){const b=new _(y.mouse_delta_pos.x,-y.mouse_delta_pos.y),p=O(b,this.units.mult.s2w);this.units.camera.pos.sub(p)}const a=t.solverGetNumBodies();for(let b=0;b<a;b++){const p=t.solverGetBodyIdBasedOnIter(b);if(this.textures.has(p))continue;const x=new N(t,p),z=x.getImplementation(t);if(x.zig==null)continue;const k=x.zig.props.pos,J=this.units.w2s(k);switch(x.zig.type){case C.disc:const st=z;e.fillStyle="#FF9011",x.zig.static&&(e.fillStyle="#fa6c90"),e.beginPath(),e.arc(J.x,J.y,this.units.mult.w2s*st.radius,0,2*Math.PI),e.fill(),e.strokeStyle="#aa4100",x.zig.static&&(e.strokeStyle="#b14d64"),e.lineWidth=.04*this.units.mult.w2s,e.stroke(),e.closePath();break;case C.rectangle:const $=z,R=$.width/2,M=$.height/2;var c=new _(-R,-M),m=new _(R,-M),u=new _(R,M),f=new _(-R,M);const H=x.zig.props.angle;c=W(c,H),m=W(m,H),u=W(u,H),f=W(f,H);const ot=T(c,k),nt=T(m,k),lt=T(u,k),rt=T(f,k),G=this.units.w2s(ot),V=this.units.w2s(nt),X=this.units.w2s(lt),Y=this.units.w2s(rt);e.fillStyle="#90FF11",x.zig.static&&(e.fillStyle="#fa6c90"),e.beginPath(),e.moveTo(G.x,G.y),e.lineTo(V.x,V.y),e.lineTo(X.x,X.y),e.lineTo(Y.x,Y.y),e.closePath(),e.fill(),e.strokeStyle="#406d0e",x.zig.static&&(e.strokeStyle="#b14d64"),e.lineWidth=.04*this.units.mult.w2s,e.stroke();break}}this.textures.forEach((b,p,x)=>{if(b!=null){const z=new N(t,b.id);b.render(e,z)}})}addStandardRigidBodyTex(t,e,i){const s=this,o={image:new Image,scale:i,id:e,render:function(n,a){const c=a.zig;if(c==null)return;const m=c.props.pos,u=s.units.w2s(m),f=s.units.mult.w2s,b=o.image.height/o.image.width,p=f*i,x=f*b*i;n.save(),n.translate(u.x,u.y),n.rotate(-c.props.angle),n.drawImage(o.image,-p/2,-x/2,p,x),n.restore()}};o.image.src=t,this.textures.set(e,o)}}const F={instance:void 0,init(l){this.instance=l.instance}};async function xt(){try{const l=await WebAssembly.instantiateStreaming(fetch("zigics.wasm"));if(F.init(l),F.instance==null){console.error("Error: BAD! `wasm.instance` is undefined");return}}catch(l){console.error("Failed to bootstrap WebAssembly module:",l)}}const B=F;setTimeout(()=>{},100);await xt();const d=(()=>{const t=document.getElementById("demo").getContext("2d"),e=new bt(t,16/9,40);if(e.units.camera.pos=new _(-25,-10),B.instance==null){console.error("Error: BAD! `wasm.instance` is undefined");return}return{c:t,renderer:e,simulating:!1,steps:0,process_dt:0,snap_to_body:!0,span_to_body_id:3n}})(),tt=60,D=1/tt;var et=0;function yt(){if(B.instance==null)return;const l=B.instance.exports;l.solverInit(2,4),l.setupBridgeStressTestScene(),d?.renderer.textures.clear(),d?.renderer.addStandardRigidBodyTex(A.red_truck,3n,6),d?.renderer.addStandardRigidBodyTex(A.wheel,4n,2.05),d?.renderer.addStandardRigidBodyTex(A.wheel,5n,2.05),d?.renderer.textures.set(6n,null)}function it(){if(B.instance==null)return;const l=B.instance.exports;l.solverInit(2,4),l.setupCarScene(),d?.renderer.textures.clear(),d?.renderer.addStandardRigidBodyTex(A.red_truck,3n,6),d?.renderer.addStandardRigidBodyTex(A.wheel,4n,2.05),d?.renderer.addStandardRigidBodyTex(A.wheel,5n,2.05),d?.renderer.textures.set(6n,null)}window.addEventListener("keydown",l=>{if(B.instance==null)return;const t=B.instance.exports,e=t.getRigidBodyPtrFromId(3n),i=t.getRigidBodyPtrFromId(4n),s=t.getRigidBodyPtrFromId(5n),o=30;l.key=="d"&&(t.setRigidBodyAngularMomentum(i,-30),t.setRigidBodyAngularMomentum(s,-30),t.setRigidBodyTorque(e,390)),l.key=="a"&&(t.setRigidBodyAngularMomentum(i,o),t.setRigidBodyAngularMomentum(s,o),t.setRigidBodyTorque(e,-390));const a=10;if(l.key=="ArrowUp"&&t.setRigidBodyMomentumY(e,a),l.key=="ArrowLeft"&&t.setRigidBodyMomentumX(e,-10),l.key=="ArrowDown"&&t.setRigidBodyMomentumY(e,-10),l.key=="ArrowRight"&&t.setRigidBodyMomentumX(e,a),l.key==" "){if(d==null)return;d.simulating=!d?.simulating}});const pt=l=>new Promise(t=>setTimeout(t,l));function vt(l){let t=0;const e=async()=>{const i=performance.now();l(),t=performance.now()-i,et=t;const o=1e3/tt-t;o>0?await pt(o):console.log("EXCEEDED TIME = "+t+" TARGET DT = "+D),requestAnimationFrame(e)};e()}it();vt(()=>{if(B.instance==null){console.error("Error: BAD! `wasm.instance` is undefined");return}if(d==null)return;wt();const l=new ut,t=l.makeWindow(w,y,{window:0,header:0,resizeable:0,close_btn:null},{title:"nvb-zigics | wasm demo",x:0,y:0,width:500,height:400}),e=B.instance.exports;t.makeLabel(w,null,"=== DEBUGS ==="),t.setMode("two columns"),t.makeLabel(w,null,"Comptime: "),t.makeLabel(w,null,Math.floor(10*et)/10+" ms"),t.makeLabel(w,null,"Process dt: "),t.makeLabel(w,null,Math.floor(10*d.process_dt)/10+" ms"),t.makeLabel(w,null,"Step: "),t.makeLabel(w,null,""+d.steps),t.makeLabel(w,null,"Num bodies: "),t.makeLabel(w,null,""+e.solverGetNumBodies()),t.makeLabel(w,null,"Mouse world pos: ");var i=new _(y.mouse_position.x,y.mouse_position.y);const s=d.c.canvas.getBoundingClientRect();i.x-=s.left,i.y-=s.top,i=d.renderer.units.s2w(i),t.makeLabel(w,null,"("+i.x+", "+i.y+")"),t.setMode("normal"),t.makeLabel(w,null,""),t.makeLabel(w,null,"=== SIMULATION ==="),t.setMode("two columns"),t.makeLabel(w,null,"Toggle simulating:"),t.makeButton(w,1,""+d.simulating),t.makeLabel(w,null,"Process once:"),t.makeButton(w,2,"Once"),t.makeLabel(w,null,"Process while held:"),t.makeDraggable(w,2,"Hold"),t.setMode("normal"),t.makeLabel(w,null,""),t.makeLabel(w,null,"=== RENDER ==="),t.setMode("two columns"),t.makeLabel(w,null,"Toggle focus camera pos to body: "),t.makeButton(w,3,""+d.snap_to_body),t.makeLabel(w,null,"Change focused body id: "),t.makeDraggable(w,4,"Id: "+d.span_to_body_id);const o=l.makeWindow(w,y,{window:0,header:0,resizeable:0,close_btn:null},{title:"init demo scenes",x:900,y:0,width:500,height:200});if(o.setMode("two columns"),o.makeLabel(w,null,"Car Scene: "),o.makeButton(w,5,"Init"),o.makeLabel(w,null,"Bridge Scene: "),o.makeButton(w,6,"Init"),d.snap_to_body){const u=new N(e,d.span_to_body_id);if(u.zig==null)return;const f=new _(d.renderer.units.camera.viewport.width,d.renderer.units.camera.viewport.height);d.renderer.units.camera.pos=Z(u.zig.props.pos,O(f,.5))}switch(l.requestAction(y).action){case 5:e.solverDeinit(),it(),d.steps=0;break;case 6:e.solverDeinit(),yt(),d.steps=0;break;case 1:d.simulating=!d.simulating;break;case 2:e.solverProcess(D,8,16),d.steps+=1;break;case 3:d.snap_to_body=!d.snap_to_body;break;case 4:const u=e.solverGetNumBodies();d.span_to_body_id=BigInt(gt(Number(d.span_to_body_id),y,2,{min:0,max:u-1}));break}const c=performance.now();d.simulating&&(e.solverProcess(D,8,16),d.steps+=1);const m=performance.now();d.process_dt=m-c,d?.renderer.render(e,d.c),w.clearRect(0,0,v.width,v.height),l.stack_render(w,y),y.end()});
